<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <title>PetCare - Login</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Formulario de inicio de sesión para el sistema de la clínica veterinaria" name="description">

    <!-- Favicon -->
    <link th:href="@{/img/favicon.ico}" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link th:href="@{/lib/animate/animate.min.css}" rel="stylesheet">
    <link th:href="@{/lib/owlcarousel/assets/owl.carousel.min.css}" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link th:href="@{/css/style.css}" rel="stylesheet">

</head>

<body>
<!-- Spinner Start (Conservado) -->
<div id="spinner"
     class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
    <div class="spinner-grow text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>
<!-- Spinner End -->


<!-- Navbar Start (Conservado con links Thymeleaf) -->
<div class="container-fluid sticky-top">
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-light border-bottom border-2 border-white">
            <a th:href="@{/index}" class="navbar-brand">
                <h1>PetCare</h1>
            </a>
            <button type="button" class="navbar-toggler ms-auto me-0" data-bs-toggle="collapse"
                    data-bs-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <div class="navbar-nav ms-auto" id="nav-links-menu">
                    <a th:href="@{/}" class="nav-item nav-link active">Inicio</a>
                    <a th:href="@{/contact}" class="nav-item nav-link">Contacto de emergencia</a>
                    <a th:href="@{/login}" class="nav-item nav-link">Iniciar Sesion</a>
                </div>
            </div>
        </nav>
    </div>
</div>
<!-- Navbar End -->


<!-- Hero Start (Adaptado para la página de Login) -->
<div class="container-fluid pb-5 bg-primary hero-header">
    <div class="container py-5">
        <div class="row g-3 align-items-center">
            <div class="col-lg-6 text-center text-lg-start">
                <h1 class="display-1 mb-0 animated slideInLeft">Iniciar Sesión</h1>
            </div>
            <div class="col-lg-6 animated slideInRight">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb justify-content-center justify-content-lg-end mb-0">
                        <li class="breadcrumb-item"><a class="text-primary" th:href="@{/index}">Home</a></li>
                        <li class="breadcrumb-item text-secondary active" aria-current="page">Login</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>
<!-- Hero End -->


<!-- Login Form Start (El contenido central que reemplaza el Contacto) -->
<div class="container-fluid py-5">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10 login-wrapper">
                <div class="form-container wow fadeIn" data-wow-delay="0.3s">
                    <h2 class="mb-4 text-center text-primary">Acceso al Sistema</h2>

                    <div id="error-message" class="message error"></div>

                    <form id="login-form">
                        <div class="form-group">
                            <label for="email" class="form-label">Email:</label>
                            <input type="email" id="email" name="email" class="form-control form-control-lg" required autofocus>
                        </div>
                        <div class="form-group">
                            <label for="contraseña" class="form-label">Contraseña:</label>
                            <input type="password" id="contraseña" name="contraseña" class="form-control form-control-lg" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">Entrar</button>
                    </form>

                    <div class="register-link text-center mt-4">
                        <p>¿No tienes una cuenta? <a th:href="@{/register}" class="text-primary fw-bold">Regístrate aquí</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Login Form End -->


<!-- Newsletter Start (Conservado) -->
<div class="container-fluid bg-primary newsletter p-0">
    <div class="container p-0">
        <div class="row g-0 align-items-center">
            <div class="col-md-5 ps-lg-0 text-start wow fadeIn" data-wow-delay="0.2s">
                <img class="img-fluid w-100" th:src="@{/img/newsletter.jpg}" alt="Newsletter Image">
            </div>
            <div class="col-md-7 py-5 newsletter-text wow fadeIn" data-wow-delay="0.5s">
                <div class="p-5">
                    <h1 class="mb-5">Subscribe the <span
                            class="text-uppercase text-primary bg-white px-2">Newsletter</span></h1>
                    <div class="position-relative w-100 mb-2">
                        <input class="form-control border-0 w-100 ps-4 pe-5" type="text"
                               placeholder="Enter Your Email" style="height: 60px;">
                        <button type="button" class="btn shadow-none position-absolute top-0 end-0 mt-2 me-2"><i
                                class="fa fa-paper-plane text-primary fs-4"></i></button>
                    </div>
                    <p class="mb-0">Diam sed sed dolor stet amet eirmod</p>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Newsletter End -->


<!-- Footer Start (Conservado con links Thymeleaf) -->
<div class="container-fluid footer pt-5">
    <div class="container py-5">
        <div class="row g-5">
            <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.1s">
                <a th:href="@{/index}" class="d-inline-block mb-3">
                    <h1 class="text">PetCare</h1>
                </a>
                <p class="mb-0">Tempor erat elitr rebum at clita. Diam dolor diam ipsum et tempor sit. Aliqu diam
                    amet diam et eos labore. Clita erat ipsum et lorem et sit, sed stet no labore lorem sit. Sanctus
                    clita duo justo et tempor</p>
            </div>
            <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.3s">
                <h5 class="text-white mb-4">Contáctanos</h5>
                <p><i class="fa fa-map-marker-alt me-3"></i>123 Street, New York, USA</p>
                <p><i class="fa fa-phone-alt me-3"></i>+012 345 67890</p>
                <p><i class="fa fa-envelope me-3"></i>info@example.com</p>
                <div class="d-flex pt-2">
                    <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                            class="fab fa-twitter"></i></a>
                    <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                            class="fab fa-facebook-f"></i></a>
                    <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                            class="fab fa-youtube"></i></a>
                    <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                            class="fab fa-instagram"></i></a>
                    <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                            class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
            <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.5s">
                <h5 class="text-white mb-4">Enlaces Populares</h5>
                <a class="btn btn-link" th:href="@{/about}">Acerca de Nosotros</a>
                <a class="btn btn-link" th:href="@{/contact}">Contáctanos</a>
                <a class="btn btn-link" href="#!">Política de Privacidad</a>
                <a class="btn btn-link" href="#!">Términos &amp; Condiciones</a>
                <a class="btn btn-link" href="#!">Carrera</a>
            </div>
            <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.7s">
                <h5 class="text-white mb-4">Nuestros Servicios</h5>
                <a class="btn btn-link" th:href="@{/service}">Diseño Interior</a>
                <a class="btn btn-link" th:href="@{/service}">Planificación de Proyectos</a>
                <a class="btn btn-link" th:href="@{/service}">Renovación</a>
                <a class="btn btn-link" th:href="@{/service}">Implementación</a>
                <a class="btn btn-link" th:href="@{/service}">Diseño de Paisajes</a>
            </div>
        </div>
    </div>
    <div class="container wow fadeIn" data-wow-delay="0.1s">
        <div class="copyright">
            <div class="row">
                <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                    &copy; <a class="border-bottom" href="#!">Your Site Name</a>, All Right Reserved.
                    Designed By <a class="border-bottom" href="https://htmlcodex.com">HTML Codex</a>. Distributed by
                    <a class="border-bottom" href="https://themewagon.com" target="_blank">ThemeWagon</a>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <div class="footer-menu">
                        <a th:href="@{/index}">Home</a>
                        <a href="#!">Cookies</a>
                        <a href="#!">Ayuda</a>
                        <a href="#!">FAQs</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Footer End -->


<!-- Back to Top (Conservado) -->
<a href="#!" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>


<!-- JavaScript Libraries (Rutas Thymeleaf) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/lib/wow/wow.min.js}"></script>
<script th:src="@{/lib/easing/easing.min.js}"></script>
<script th:src="@{/lib/waypoints/waypoints.min.js}"></script>
<script th:src="@{/lib/owlcarousel/owl.carousel.min.js}"></script>
<script th:src="@{/js/main.js}"></script>

<!-- Script de Funcionalidad de Login (Conservado) -->
<script>
    new WOW().init();

    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            return JSON.parse(atob(base64));
        } catch (e) {
            console.error("Error al parsear JWT:", e);
            return null;
        }
    }

    document.getElementById('login-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const email = document.getElementById('email').value;
        const contraseña = document.getElementById('contraseña').value;
        const errorMessageDiv = document.getElementById('error-message');
        errorMessageDiv.style.display = 'none';

        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, contraseña })
            });

            if (response.ok) {
                const data = await response.json();

                localStorage.setItem('jwt_token', data.token);
                document.cookie = `jwt_token=${data.token}; path=/; SameSite=Strict`;

                const userData = parseJwt(data.token);
                if (!userData || !userData.role) {
                    errorMessageDiv.textContent = "Error: El token no contiene el rol del usuario.";
                    errorMessageDiv.style.display = 'block';
                    return;
                }

                switch (userData.role) {
                    case 'DUEÑO':
                        window.location.href = '/mascotas';
                        break;
                    case 'VETERINARIO':
                    case 'ASISTENTE':
                        window.location.href = '/agenda';
                        break;
                    default:
                        window.location.href = '/';
                        break;
                }

            } else {
                errorMessageDiv.textContent = 'Email o contraseña incorrectos.';
                errorMessageDiv.style.display = 'block';
            }
        } catch (error) {
            console.error("Error en la solicitud de login:", error);
            errorMessageDiv.textContent = 'Error de conexión. Inténtalo de nuevo.';
            errorMessageDiv.style.display = 'block';
        }
    });
</script>
</body>

</html>
