<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="~{common/head :: head_piezita}"></th:block>
    <title>PetCare - Formulario de Mascota</title>

    <style>
        .form-container-custom {
            max-width: 600px;
            margin: 0 auto;
            padding: 30px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #form-title {
            margin-bottom: 25px;
            color: var(--bs-primary);
        }

        .form-floating label {
            color: #6c757d;
        }
    </style>
</head>

<body>
<div id="spinner"
    class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
    <div class="spinner-grow text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="sr-only">Cargando...</span>
    </div>
</div>

<div class="container-fluid sticky-top">
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-light border-bottom border-2 border-white">
            <a th:href="@{/}" class="navbar-brand">
                <h1>PetCare</h1>
            </a>
            <button type="button" class="navbar-toggler ms-auto me-0" data-bs-toggle="collapse"
                    data-bs-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <div class="navbar-nav ms-auto" id="nav-links-menu">
                    <a th:href="@{/}" class="nav-item nav-link active">Inicio</a>
                    <a th:href="@{/contact}" class="nav-item nav-link">Contacto de emergencia</a>
                    <p class="nav-item nav-link text-muted">Cargando...</p>
                </div>
            </div>
        </nav>
    </div>
</div>

<div class="container-fluid pb-5 bg-primary hero-header">
    <div class="container py-5">
        <div class="row g-3 align-items-center">
            <div class="col-lg-6 text-center text-lg-start">
                <h1 class="display-1 mb-0 animated slideInLeft" id="hero-title">Registrar Mascota</h1>
            </div>
        </div>
    </div>
</div>


<div class="container-fluid py-5">
    <div class="container py-5">
        <div class="form-container-custom wow fadeIn" data-wow-delay="0.3s">
            <h2 class="text-center" id="form-title">Registrar Nueva Mascota</h2>
            <div id="message-container" class="my-3" role="alert" style="display: none;"></div>

            <form id="pet-form">
                <input type="hidden" id="id">

                <div class="row g-3">
                    <div class="col-12">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="nombre" placeholder="Nombre de tu Mascota" required>
                            <label for="nombre">Nombre:</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="especie" placeholder="Especie (Ej: Perro, Gato)" required>
                            <label for="especie">Especie:</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="raza" placeholder="Raza" required>
                            <label for="raza">Raza:</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="fechaNacimiento" required>
                            <label for="fechaNacimiento">Fecha de Nacimiento:</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary w-100 py-3" id="submit-button">Guardar Mascota</button>
                        <a th:href="@{/mascotas}" class="btn btn-outline-secondary w-100 py-2 mt-2">Cancelar</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:replace="~{common/footer :: footer_piezita}"></div>


<script>
    function showMessage(type, message) {
        const container = document.getElementById('message-container');
        container.textContent = message;
        container.style.display = 'block';
        container.className = `alert alert-${type}`;
    }

    function parseJwt(token) {
        try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
    }

    function setupNavbar(token, userData) {
        const navLinksMenu = document.getElementById('nav-links-menu');
        const navItemClass = 'nav-item nav-link';

        let menuHTML = '';

        if (token && userData) {
            const userRole = userData.role;

            menuHTML += `<a href="/" class="${navItemClass}">Inicio</a>`;

            if (userRole === 'VETERINARIO' || userRole === 'ASISTENTE') {
                menuHTML += `<a href="/gestion-citas" class="${navItemClass}">Gestión Citas</a>`;
                menuHTML += `<a href="/agenda" class="${navItemClass}">Mi Agenda</a>`;
            } else {
                menuHTML += `<a href="/mascotas" class="${navItemClass}">Mis Mascotas</a>`;
                menuHTML += `<a href="/pagos" class="${navItemClass}">Mis Pagos</a>`;
                menuHTML += `<a href="/mascota-formulario" class="${navItemClass} active">Añadir Nueva Mascota</a>`;
            }

            menuHTML += `<a href="/contact" class="${navItemClass}">Contacto de emergencia</a>`;

            menuHTML += `<a href="#" id="logout-btn-menu" class="${navItemClass}">Cerrar Sesión</a>`;

        } else {
            menuHTML =
                `<a href="/" class="${navItemClass}">Inicio</a>
                 <a href="/contact" class="${navItemClass}">Contacto de emergencia</a>
                 <a href="/login" class="${navItemClass}">Iniciar Sesión</a>`; 
        }

        if (navLinksMenu) {
            navLinksMenu.innerHTML = menuHTML;
        }

        const logoutBtn = document.getElementById('logout-btn-menu');
        if (logoutBtn) {
             logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('jwt_token');
                alert('Has cerrado la sesión.');
                window.location.href = '/';
            });
        }
    }


    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('jwt_token');

        if (!token) {
            setupNavbar(null, null);
            window.location.href = '/login';
            return;
        }

        const userData = parseJwt(token);
        if (!userData) {
            console.error("Token JWT inválido o incompleto.");
            localStorage.removeItem('jwt_token');
            setupNavbar(null, null);
            window.location.href = '/login';
            return;
        }

        setupNavbar(token, userData);

        new WOW().init();

        const form = document.getElementById('pet-form');
        const formTitleElement = document.getElementById('form-title');
        const heroTitleElement = document.getElementById('hero-title');
        const idInput = document.getElementById('id');
        const submitButton = document.getElementById('submit-button');


        const urlParams = new URLSearchParams(window.location.search);
        const petId = urlParams.get('id');


        if (petId) {
            formTitleElement.textContent = 'Editar Mascota';
            heroTitleElement.textContent = 'Editar Mascota';
            submitButton.textContent = 'Guardar Cambios';
            idInput.value = petId;

            try {
                const response = await fetch(`/api/mascotas/${petId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('No se pudo cargar la mascota.');

                const mascota = await response.json();

                document.getElementById('nombre').value = mascota.nombre;
                document.getElementById('especie').value = mascota.especie;
                document.getElementById('raza').value = mascota.raza;
                document.getElementById('fechaNacimiento').value = mascota.fechaNacimiento;

            } catch (error) {
                console.error('Error al cargar la mascota:', error);
                showMessage('danger', 'Error al cargar los datos de la mascota.');
                setTimeout(() => { window.location.href = '/mascotas'; }, 2000);
            }
        } else {
            formTitleElement.textContent = 'Registrar Nueva Mascota';
            heroTitleElement.textContent = 'Registrar Mascota';
            submitButton.textContent = 'Registrar Mascota';
        }


        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            document.getElementById('message-container').style.display = 'none';

            const mascotaData = {
                nombre: document.getElementById('nombre').value,
                especie: document.getElementById('especie').value,
                raza: document.getElementById('raza').value,
                fechaNacimiento: document.getElementById('fechaNacimiento').value,
                duenoId: userData.userId
            };

            const currentPetId = idInput.value;
            const isEditing = !!currentPetId;

            const method = isEditing ? 'PUT' : 'POST';
            const url = isEditing ? `/api/mascotas/${currentPetId}` : '/api/mascotas';
            const successMessage = isEditing ? '¡Mascota actualizada con éxito! Redirigiendo...' : '¡Mascota registrada con éxito! Redirigiendo...';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(mascotaData)
                });

                if (response.ok) {
                    showMessage('success', successMessage);
                    setTimeout(() => {
                        window.location.href = '/mascotas';
                    }, 1500);
                } else {
                    const errorData = await response.json();
                    const errorMessage = errorData.message || 'No se pudo guardar la mascota. Verifique los datos.';
                    showMessage('danger', `Error: ${errorMessage}`);
                }
            } catch (error) {
                console.error('Error de conexión o de la API:', error);
                showMessage('danger', 'Error de conexión con el servidor. Inténtelo de nuevo.');
            }
        });
    });
</script>
    <script src="/js/script.js"></script>

</html>
