<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <title>PetCare - Agendar Cita</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Formulario para agendar una nueva cita médica para la mascota" name="keywords">
    <meta content="Agendar Cita Médica" name="description">

    <link th:href="@{/img/favicon.ico}" rel="icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <link th:href="@{/lib/animate/animate.min.css}" rel="stylesheet">
    <link th:href="@{/lib/owlcarousel/assets/owl.carousel.min.css}" rel="stylesheet">

    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">

    <link th:href="@{/css/style.css}" rel="stylesheet">

    <style>
        .container-citas {
            min-height: 70vh;
            padding: 50px 0;
        }

        .form-container-custom {
            max-width: 600px;
            margin: 0 auto;
            padding: 30px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #form-title {
            margin-bottom: 25px;
            color: var(--bs-primary);
        }

        .form-floating label {
            color: #6c757d;
        }

        .message-container {
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            font-weight: 600;
        }
        .message-container.alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message-container.alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>

<body>
    <div id="spinner"
        class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-grow text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Cargando...</span>
        </div>
    </div>
    <div class="container-fluid sticky-top">
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-light border-bottom border-2 border-white">
                <a th:href="@{/}" class="navbar-brand">
                    <h1>PetCare</h1>
                </a>
                <button type="button" class="navbar-toggler ms-auto me-0" data-bs-toggle="collapse"
                        data-bs-target="#navbarCollapse">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <div class="navbar-nav ms-auto" id="nav-links-menu">
                        <p class="nav-item nav-link text-muted">Cargando opciones...</p>
                    </div>
                </div>
            </nav>
        </div>
    </div>
    <div class="container-fluid pb-5 bg-primary hero-header">
        <div class="container py-5">
            <div class="row g-3 align-items-center">
                <div class="col-lg-6 text-center text-lg-start">
                    <h1 class="display-3 mb-0 text-white" id="hero-title">Agendar Nueva Cita</h1>
                    
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid py-5 container-citas">
        <div class="container py-5">
            <div class="form-container-custom wow fadeIn" data-wow-delay="0.3s">
                <h2 class="text-center" id="form-title">Agendar Cita</h2>
                
                <div id="message-container" class="my-3 message-container" role="alert" style="display: none;"></div>

                <form id="cita-form">
                    <input type="hidden" id="mascotaIdInput">
                    <input type="hidden" id="veterinarioId" value="1"> 

                    <div class="row g-3">
                        <div class="col-12">
                            <div class="form-floating">
                                <input type="datetime-local" class="form-control" id="fechaHora" placeholder="Fecha y Hora" required>
                                <label for="fechaHora">Fecha y Hora:</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="motivo" placeholder="Motivo de la Cita" required>
                                <label for="motivo">Motivo de la Cita:</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary w-100 py-3">Agendar Cita</button>
                            <a href="/mascotas" class="btn btn-outline-secondary w-100 py-2 mt-2" id="btn-cancel">Cancelar</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="container-fluid footer pt-5">
        <div class="container py-5">
            <div class="row g-5">
                <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.1s">
                    <a th:href="@{/index}" class="d-inline-block mb-3">
                        <h1 class="text-white">PetCare</h1>
                    </a>
                    <p class="mb-0">Tempor erat elitr rebum at clita. Diam dolor diam ipsum et tempor sit. Aliqu diam
                        amet diam et eos labore. Clita erat ipsum et lorem et sit, sed stet no labore lorem sit. Sanctus
                        clita duo justo et tempor</p>
                </div>
                <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.3s">
                    <h5 class="text-white mb-4">Contáctanos</h5>
                    <p><i class="fa fa-map-marker-alt me-3"></i>123 Street, New York, USA</p>
                    <p><i class="fa fa-phone-alt me-3"></i>+012 345 67890</p>
                    <p><i class="fa fa-envelope me-3"></i>info@example.com</p>
                    <div class="d-flex pt-2">
                        <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                                class="fab fa-twitter"></i></a>
                        <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                                class="fab fa-facebook-f"></i></a>
                        <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                                class="fab fa-youtube"></i></a>
                        <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                                class="fab fa-instagram"></i></a>
                        <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                                class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.5s">
                    <h5 class="text-white mb-4">Enlaces Populares</h5>
                    <a class="btn btn-link" th:href="@{/about}">Acerca de Nosotros</a>
                    <a class="btn btn-link" th:href="@{/contact}">Contáctanos</a>
                    <a class="btn btn-link" href="#!">Política de Privacidad</a>
                    <a class="btn btn-link" href="#!">Términos &amp; Condiciones</a>
                    <a class="btn btn-link" href="#!">Carrera</a>
                </div>
                <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.7s">
                    <h5 class="text-white mb-4">Nuestros Servicios</h5>
                    <a class="btn btn-link" th:href="@{/service}">Diseño Interior</a>
                    <a class="btn btn-link" th:href="@{/service}">Planificación de Proyectos</a>
                    <a class="btn btn-link" th:href="@{/service}">Renovación</a>
                    <a class="btn btn-link" th:href="@{/service}">Implementación</a>
                    <a class="btn btn-link" th:href="@{/service}">Diseño de Paisajes</a>
                </div>
            </div>
        </div>
        <div class="container wow fadeIn" data-wow-delay="0.1s">
            <div class="copyright">
                <div class="row">
                    <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                        &copy; <a class="border-bottom" href="#!">Your Site Name</a>, All Right Reserved.
                        Designed By <a class="border-bottom" href="https://htmlcodex.com">HTML Codex</a>. Distributed by
                        <a class="border-bottom" href="https://themewagon.com" target="_blank">ThemeWagon</a>
                    </div>
                    <div class="col-md-6 text-center text-md-end">
                        <div class="footer-menu">
                            <a th:href="@{/index}">Home</a>
                            <a href="#!">Cookies</a>
                            <a href="#!">Ayuda</a>
                            <a href="#!">FAQs</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a href="#!" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/lib/wow/wow.min.js}"></script>
    <script th:src="@{/lib/easing/easing.min.js}"></script>
    <script th:src="@{/lib/waypoints/waypoints.min.js}"></script>
    <script th:src="@{/lib/owlcarousel/owl.carousel.min.js}"></script>

    <script th:src="@{/js/main.js}"></script>

    <script>
        function parseJwt(token) {
            try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
        }
        
        function showMessage(type, message) {
            const container = document.getElementById('message-container');
            container.textContent = message;
            container.style.display = 'block';
            container.className = `my-3 message-container alert-${type}`;
        }
        
        function setupNavbar(token) {
            const navLinksMenu = document.getElementById('nav-links-menu');
            const navItemClass = 'nav-item nav-link';
            let menuHTML = '';

            const userData = token ? parseJwt(token) : null;

            if (userData) {
                const userRole = userData.role;

                menuHTML += `<a href="/" class="${navItemClass}">Inicio</a>`;

                if (userRole === 'VETERINARIO' || userRole === 'ASISTENTE') {
                    menuHTML += `<a href="/gestion-citas" class="${navItemClass}">Gestión Citas</a>`;
                    menuHTML += `<a href="/agenda" class="${navItemClass}">Mi Agenda</a>`;
                } else {
                    menuHTML += `<a href="/mascotas" class="${navItemClass}">Mis Mascotas</a>`;
                    menuHTML += `<a href="/mascota-formulario" class="${navItemClass}">Añadir Nueva Mascota</a>`;
                }

                menuHTML += `<a href="/contact" class="${navItemClass}">Contacto de emergencia</a>`;
                menuHTML += `<a href="#" id="logout-btn-menu" class="${navItemClass}">Cerrar Sesión</a>`;

            } else {
                menuHTML =
                    `<a href="/" class="${navItemClass}">Inicio</a>
                    <a href="/contact" class="${navItemClass}">Contacto de emergencia</a>
                    <a href="/login" class="${navItemClass}">Iniciar Sesión</a>`;
            }

            if (navLinksMenu) {
                navLinksMenu.innerHTML = menuHTML;
            }

            document.addEventListener('click', (e) => {
                if (e.target.id === 'logout-btn-menu') {
                    e.preventDefault();
                    localStorage.removeItem('jwt_token');
                    alert('Has cerrado la sesión.');
                    window.location.href = '/';
                }
            });
        }


        document.addEventListener('DOMContentLoaded', async () => {
            new WOW().init();

            const token = localStorage.getItem('jwt_token');
            setupNavbar(token);

            if (!token) { 
                window.location.href = '/login'; 
                return; 
            }

            const params = new URLSearchParams(window.location.search);
            const mascotaId = params.get('mascotaId');
            
            if (!mascotaId) {
                showMessage('danger', 'Error: ID de mascota no encontrado. Redirigiendo...');
                setTimeout(() => { window.location.href = '/mascotas'; }, 2000);
                return;
            }
            
            document.getElementById('mascotaIdInput').value = mascotaId;
            document.getElementById('btn-cancel').href = `/mascota-detalle?id=${mascotaId}`;

            const form = document.getElementById('cita-form');
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                document.getElementById('message-container').style.display = 'none';

                const citaData = {
                    fechaHora: document.getElementById('fechaHora').value,
                    motivo: document.getElementById('motivo').value,
                    estado: 'PROGRAMADA',
                    mascotaId: mascotaId,
                    veterinarioId: document.getElementById('veterinarioId').value
                };

                try {
                    const response = await fetch('/api/citas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(citaData)
                    });

                    if (response.ok) {
                        showMessage('success', '¡Cita agendada con éxito! Redirigiendo...');
                        setTimeout(() => {
                            window.location.href = `/mascota-detalle?id=${mascotaId}`;
                        }, 1500);
                    
                    } else {
                        const errorData = await response.json();
                        const errorMessage = errorData.message || 'Error al agendar la cita. Verifique la fecha/hora.';
                        showMessage('danger', `Error: ${errorMessage}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showMessage('danger', 'Error de conexión con el servidor. Inténtelo de nuevo.');
                }
            });
        });
    </script>
</body>

</html>