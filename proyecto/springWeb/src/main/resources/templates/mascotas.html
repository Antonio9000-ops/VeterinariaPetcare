<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <title>PetCare - Mis Mascotas</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Gestión de mascotas del usuario" name="keywords">
    <meta content="Lista y administración de las mascotas registradas" name="description">

    <!-- Favicon -->
    <link th:href="@{/img/favicon.ico}" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Space+Grotesk&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link th:href="@{/lib/animate/animate.min.css}" rel="stylesheet">
    <link th:href="@{/lib/owlcarousel/assets/owl.carousel.min.css}" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link th:href="@{/css/style.css}" rel="stylesheet">

    <!-- Estilos específicos para la gestión de mascotas (adaptados al tema) -->
    <style>
        .container-mascotas {
            min-height: 70vh;
            padding: 50px 0;
        }


        .pet-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        .pet-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin-bottom: 15px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--bs-primary); /* Usa el color primario del template */
        }

        .pet-info {
            font-size: 1.1rem;
        }

        .pet-actions a,
        .pet-actions button {
            margin-left: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            padding: 8px 15px;
            transition: all 0.2s;
        }

        .error-message {
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        .error-message.alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .error-message.alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>

<body>
<!-- Spinner Start -->
<div id="spinner"
     class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
    <div class="spinner-grow text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="sr-only">Cargando...</span>
    </div>
</div>
<!-- Spinner End -->


<!-- Navbar Start -->
<div class="container-fluid sticky-top">
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-light border-bottom border-2 border-white">
            <a th:href="@{/}" class="navbar-brand">
                <h1>PetCare</h1>
            </a>
            <button type="button" class="navbar-toggler ms-auto me-0" data-bs-toggle="collapse"
                    data-bs-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <div class="navbar-nav ms-auto" id="nav-links-menu">
                    <a th:href="@{/}" class="nav-item nav-link active">Inicio</a>
                    <a th:href="@{/contact}" class="nav-item nav-link">Contacto de emergencia</a>
                    <p class="nav-item nav-link text-muted">Cargando...</p>
                </div>
            </div>
        </nav>
    </div>
</div>
<!-- Navbar End -->

<div class="container-fluid pb-5 bg-primary hero-header">
    <div class="container py-5">
        <div class="row g-3 align-items-center">
            <div class="col-lg-6 text-center text-lg-start">
                <h1 class="display-1 mb-0 animated slideInLeft" id="hero-title">Gestión de mis mascotas</h1>
            </div>
        </div>
    </div>
</div>
<!-- Contenido Dinámico: Mis Mascotas Start -->
<div class="container-fluid py-5 bg-white container-mascotas">
    <div class="container">

        <a th:href="@{/mascota-formulario}" class="btn btn-add d-inline-block mb-4">Añadir Nueva Mascota <i class="fa fa-plus ms-2"></i></a>

        <div id="error-message" class="error-message" style="display: none;"></div>

        <div class="row wow fadeIn" data-wow-delay="0.3s">
            <div class="col-12">
                <ul id="pet-list" class="pet-list">
                    <!-- Las mascotas se cargarán aquí mediante JavaScript -->
                    <li class="text-center text-muted py-5">Cargando tus mascotas...</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<!-- Contenido Dinámico: Mis Mascotas End -->


<!-- Footer Start (Utilizado de la plantilla original) -->
<div class="container-fluid footer pt-5">
    <div class="container py-5">
        <div class="row g-5">
            <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.1s">
                <a th:href="@{/index}" class="d-inline-block mb-3">
                    <h1 class="text">PetCare</h1>
                </a>
                <p class="mb-0">Tempor erat elitr rebum at clita. Diam dolor diam ipsum et tempor sit. Aliqu diam
                    amet diam et eos labore. Clita erat ipsum et lorem et sit, sed stet no labore lorem sit. Sanctus
                    clita duo justo et tempor</p>
            </div>
            <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.3s">
                <h5 class="text-white mb-4">Contáctanos</h5>
                <p><i class="fa fa-map-marker-alt me-3"></i>123 Street, New York, USA</p>
                <p><i class="fa fa-phone-alt me-3"></i>+012 345 67890</p>
                <p><i class="fa fa-envelope me-3"></i>info@example.com</p>
                <div class="d-flex pt-2">
                    <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                            class="fab fa-twitter"></i></a>
                    <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                            class="fab fa-facebook-f"></i></a>
                    <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                            class="fab fa-youtube"></i></a>
                    <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                            class="fab fa-instagram"></i></a>
                    <a class="btn btn-outline-primary btn-square border-2 me-2" href="#!"><i
                            class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
            <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.5s">
                <h5 class="text-white mb-4">Enlaces Populares</h5>
                <a class="btn btn-link" th:href="@{/about}">Acerca de Nosotros</a>
                <a class="btn btn-link" th:href="@{/contact}">Contáctanos</a>
                <a class="btn btn-link" href="#!">Política de Privacidad</a>
                <a class="btn btn-link" href="#!">Términos &amp; Condiciones</a>
                <a class="btn btn-link" href="#!">Carrera</a>
            </div>
            <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.7s">
                <h5 class="text-white mb-4">Nuestros Servicios</h5>
                <a class="btn btn-link" th:href="@{/service}">Diseño Interior</a>
                <a class="btn btn-link" th:href="@{/service}">Planificación de Proyectos</a>
                <a class="btn btn-link" th:href="@{/service}">Renovación</a>
                <a class="btn btn-link" th:href="@{/service}">Implementación</a>
                <a class="btn btn-link" th:href="@{/service}">Diseño de Paisajes</a>
            </div>
        </div>
    </div>
    <div class="container wow fadeIn" data-wow-delay="0.1s">
        <div class="copyright">
            <div class="row">
                <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                    &copy; <a class="border-bottom" href="#!">Your Site Name</a>, All Right Reserved.
                    Designed By <a class="border-bottom" href="https://htmlcodex.com">HTML Codex</a>. Distributed by
                    <a class="border-bottom" href="https://themewagon.com" target="_blank">ThemeWagon</a>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <div class="footer-menu">
                        <a th:href="@{/index}">Home</a>
                        <a href="#!">Cookies</a>
                        <a href="#!">Ayuda</a>
                        <a href="#!">FAQs</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Footer End -->


<!-- Back to Top -->
<a href="#!" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>


<!-- JavaScript Libraries -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/lib/wow/wow.min.js}"></script>
<script th:src="@{/lib/easing/easing.min.js}"></script>
<script th:src="@{/lib/waypoints/waypoints.min.js}"></script>
<script th:src="@{/lib/owlcarousel/owl.carousel.min.js}"></script>

<!-- Template Javascript (Se asume que main.js inicializa WOW.js y otros efectos) -->
<script th:src="@{/js/main.js}"></script>

<!-- Lógica de autenticación y gestión de mascotas -->
<script>
    // Función para decodificar el JWT
    function parseJwt(token) {
        try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
    }

    // Función para mostrar mensajes de éxito o error
    function showMessage(message, type = 'danger') {
        const errorMessageDiv = document.getElementById('error-message');
        errorMessageDiv.textContent = message;
        errorMessageDiv.className = `error-message alert-${type}`;
        errorMessageDiv.style.display = 'block';
        // Ocultar el mensaje después de 5 segundos si es éxito
        if (type === 'success') {
            setTimeout(() => {
                errorMessageDiv.style.display = 'none';
            }, 5000);
        }
    }

    // FUNCIÓN MODIFICADA: Ahora configura la navegación completa
    function setupNavbar(token) {
        const navLinksMenu = document.getElementById('nav-links-menu');
        const navItemClass = 'nav-item nav-link';
        let menuHTML = '';

        const userData = token ? parseJwt(token) : null;

        if (userData) {
            // USUARIO LOGEADO
            const userRole = userData.role;

            menuHTML += `<a href="/" class="${navItemClass}">Inicio</a>`;

            if (userRole === 'VETERINARIO' || userRole === 'ASISTENTE') {
                // Enlaces de gestión para personal de clínica
                menuHTML += `<a href="/gestion-citas" class="${navItemClass}">Gestión Citas</a>`;
                menuHTML += `<a href="/agenda" class="${navItemClass}">Mi Agenda</a>`;
            } else {
                // Enlaces de usuario normal (Mis Mascotas está activo en esta página)
                menuHTML += `<a href="/mascotas" class="${navItemClass} active">Mis Mascotas</a>`;
                menuHTML += `<a href="/mascota-formulario" class="${navItemClass}">Añadir Nueva Mascota</a>`;
            }

            // Contacto y Cerrar Sesión
            menuHTML += `<a href="/contact" class="${navItemClass}">Contacto de emergencia</a>`;
            menuHTML += `<a href="#" id="logout-btn-menu" class="${navItemClass}">Cerrar Sesión</a>`;

        } else {
            // USUARIO NO LOGEADO
            menuHTML =
                `<a href="/" class="${navItemClass}">Inicio</a>
                 <a href="/contact" class="${navItemClass}">Contacto de emergencia</a>
                 <a href="/login" class="${navItemClass}">Iniciar Sesión</a>`; // Botón de Iniciar Sesión
        }

        if (navLinksMenu) {
            navLinksMenu.innerHTML = menuHTML;
        }

        // Manejador de eventos para el cierre de sesión (aplica solo si el usuario está logeado)
        const logoutBtn = document.getElementById('logout-btn-menu');
        if (logoutBtn) {
             logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('jwt_token');
                alert('Has cerrado la sesión.');
                // Redirige al inicio
                window.location.href = '/';
            });
        }
    }


    // Función para eliminar una mascota
    window.eliminarMascota = async function(mascotaId) {
        if (!window.confirm('¿Estás seguro de que quieres eliminar esta mascota?')) {
            return;
        }

        const token = localStorage.getItem('jwt_token');
        // ... (resto de la lógica de eliminación) ...
        try {
            const response = await fetch(`/api/mascotas/${mascotaId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                showMessage('Mascota eliminada correctamente.', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                const errorData = await response.json();
                throw new Error(errorData.message || 'No se pudo eliminar la mascota.');
            }
        } catch (error) {
            showMessage(`Error: ${error.message}`);
        }
    }

    // Carga y muestra la lista de mascotas
    window.addEventListener('DOMContentLoaded', async () => {
        new WOW().init();

        const token = localStorage.getItem('jwt_token');
        const petList = document.getElementById('pet-list');

        // Configurar el Navbar primero
        setupNavbar(token);

        if (!token) {
            window.location.href = '/login';
            return;
        }

        const userData = parseJwt(token);
        if (!userData || !userData.userId) {
            petList.innerHTML = '';
            showMessage('Error: No se pudo obtener el ID del usuario del token.');
            // Asegurar redirección si el token no es válido o está incompleto
            setTimeout(() => { localStorage.removeItem('jwt_token'); window.location.href = '/login'; }, 2000);
            return;
        }

        const duenoId = userData.userId;

        try {
            const response = await fetch(`/api/mascotas/dueno/${duenoId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'No se pudieron cargar las mascotas.');
            }

            const mascotas = await response.json();
            petList.innerHTML = '';

            if (mascotas.length === 0) {
                petList.innerHTML = '<li class="text-center text-muted py-3">Aún no tienes mascotas registradas. ¡Añade una ahora!</li>';
                return;
            }

            mascotas.forEach(mascota => {
                // Uso de rutas relativas directas en los atributos href
                const listItem = document.createElement('li');
                listItem.className = 'pet-item wow fadeIn';
                listItem.setAttribute('data-wow-delay', '0.1s');

                listItem.innerHTML = `
                    <div class="pet-info">
                        <strong>${mascota.nombre}</strong> (${mascota.especie} - ${mascota.raza})
                    </div>
                    <div class="pet-actions">
                        <a href="/mascota-detalle?id=${mascota.id}" class="btn btn-outline-info border-2">Ver Detalle</a>
                        <a href="/cita-formulario?mascotaId=${mascota.id}" class="btn btn-outline-primary border-2">Agendar nueva cita</a>
                        <a href="/mascota-formulario?id=${mascota.id}" class="btn btn-outline-primary border-2">Editar datos</a>
                        <button onclick="eliminarMascota(${mascota.id})" class="btn btn-outline-danger border-2">Eliminar mascota</button>
                    </div>
                `;
                petList.appendChild(listItem);
            });

        } catch (error) {
            console.error('Error al cargar las mascotas:', error);
            petList.innerHTML = '';
            showMessage(`Error al cargar las mascotas: ${error.message}`);
        }
    });
</script>
</body>

</html>
