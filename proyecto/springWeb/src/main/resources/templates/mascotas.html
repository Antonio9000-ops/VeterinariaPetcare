<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="~{common/head :: head_piezita}"></th:block>
    <title>PetCare - Mis Mascotas</title>

</head>

<body>
    <div id="spinner"
        class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-grow text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Cargando...</span>
        </div>
    </div>


    <div class="container-fluid sticky-top">
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-light border-bottom border-2 border-white">
                <a th:href="@{/}" class="navbar-brand">
                    <h1>PetCare</h1>
                </a>
                <button type="button" class="navbar-toggler ms-auto me-0" data-bs-toggle="collapse"
                    data-bs-target="#navbarCollapse">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <div class="navbar-nav ms-auto" id="nav-links-menu">
                        <a th:href="@{/}" class="nav-item nav-link active">Inicio</a>
                        <a th:href="@{/contact}" class="nav-item nav-link">Contacto de emergencia</a>
                        <p class="nav-item nav-link text-muted">Cargando...</p>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <div class="container-fluid pb-5 bg-primary hero-header">
        <div class="container py-5">
            <div class="row g-3 align-items-center">
                <div class="col-lg-6 text-center text-lg-start">
                    <h1 class="display-1 mb-0 animated slideInLeft" id="hero-title">Gestión de mis mascotas</h1>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid py-5 bg-white container-mascotas">
        <div class="container">

            <a th:href="@{/mascota-formulario}" class="btn btn-add d-inline-block mb-4">Añadir Nueva Mascota <i
                    class="fa fa-plus ms-2"></i></a>

            <div id="error-message" class="error-message" style="display: none;"></div>

            <div class="row wow fadeIn" data-wow-delay="0.3s">
                <div class="col-12">
                    <ul id="pet-list" class="pet-list">
                        <li class="text-center text-muted py-5">Cargando tus mascotas...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>


<div th:replace="~{common/footer :: footer_piezita}"></div>

    <script>
        function showMessage(message, type = 'danger') {
            const errorMessageDiv = document.getElementById('error-message');
            errorMessageDiv.textContent = message;
            errorMessageDiv.className = `error-message alert-${type}`;
            errorMessageDiv.style.display = 'block';
            if (type === 'success') {
                setTimeout(() => {
                    errorMessageDiv.style.display = 'none';
                }, 5000);
            }
        }

        window.eliminarMascota = async function (mascotaId) {
            if (!window.confirm('¿Estás seguro de que quieres eliminar esta mascota?')) {
                return;
            }

            const token = localStorage.getItem('jwt_token');
            try {
                const response = await fetch(`/api/mascotas/${mascotaId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showMessage('Mascota eliminada correctamente.', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'No se pudo eliminar la mascota.');
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`);
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            new WOW().init();

            const token = localStorage.getItem('jwt_token');
            const petList = document.getElementById('pet-list');

            if (!token) {
                window.location.href = '/login';
                return;
            }

            const userData = parseJwt(token);
            if (!userData || !userData.userId) {
                petList.innerHTML = '';
                showMessage('Error: No se pudo obtener el ID del usuario del token.');
                setTimeout(() => { localStorage.removeItem('jwt_token'); window.location.href = '/login'; }, 2000);
                return;
            }

            const duenoId = userData.userId;

            try {
                const response = await fetch(`/api/mascotas/dueno/${duenoId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'No se pudieron cargar las mascotas.');
                }

                const mascotas = await response.json();
                petList.innerHTML = '';

                if (mascotas.length === 0) {
                    petList.innerHTML = '<li class="text-center text-muted py-3">Aún no tienes mascotas registradas. ¡Añade una ahora!</li>';
                    return;
                }

                mascotas.forEach(mascota => {
                    const listItem = document.createElement('li');
                    listItem.className = 'pet-item wow fadeIn';
                    listItem.setAttribute('data-wow-delay', '0.1s');

                    listItem.innerHTML = `
                    <div class="pet-info">
                        <strong>${mascota.nombre}</strong> (${mascota.especie} - ${mascota.raza})
                    </div>
                    <div class="pet-actions">
                        <a href="/mascota-detalle?id=${mascota.id}" class="btn btn-outline-info border-2">Ver Detalle</a>
                        <a href="/cita-formulario?mascotaId=${mascota.id}" class="btn btn-outline-primary border-2">Agendar nueva cita</a>
                        <a href="/mascota-formulario?id=${mascota.id}" class="btn btn-outline-primary border-2">Editar datos</a>
                        <button onclick="eliminarMascota(${mascota.id})" class="btn btn-outline-danger border-2">Eliminar mascota</button>
                    </div>
                `;
                    petList.appendChild(listItem);
                });

            } catch (error) {
                console.error('Error al cargar las mascotas:', error);
                petList.innerHTML = '';
                showMessage(`Error al cargar las mascotas: ${error.message}`);
            }
        });
    </script>
    <script src="/js/script.js"></script>

</body>

</html>
