services:
  app:
    image: maven:3.9.6-eclipse-temurin-21-alpine
    container_name: spring_petcare_app
    working_dir: /app
    ports:
      - "8092:8092"
    volumes:
      - ./:/app
      - maven-repo:/root/.m2
    command: mvn spring-boot:run -Dspring-boot.run.profiles=docker
    environment:
      # --- BASE DE DATOS (Sobrescribe application.properties) ---
      - SPRING_DATASOURCE_URL=jdbc:mysql://db:3306/clinica_db?allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root

      # --- RUTAS ABSOLUTAS EN DOCKER (CRÍTICO) ---
      - SPRING_THYMELEAF_PREFIX=file:/app/src/main/resources/templates/
      - SPRING_WEB_RESOURCES_STATIC_LOCATIONS=file:/app/src/main/resources/static/

      # --- CONFIGURACIÓN AGGRESIVA PARA HOT RELOAD EN DOCKER ---
      - SPRING_DEVTOOLS_RESTART_ENABLED=true
      - SPRING_DEVTOOLS_LIVERELOAD_ENABLED=true
      - SPRING_DEVTOOLS_RESTART_POLL_INTERVAL=500      # ¡Más rápido! Escanea cada 0.5s
      - SPRING_DEVTOOLS_RESTART_QUIET_PERIOD=200       # Espera solo 0.2s
      - SPRING_DEVTOOLS_RESTART_EXCLUDE=static/**,public/**
      - SPRING_DEVTOOLS_RESTART_ADDITIONAL_PATHS=/app/src/main/resources/static

      # --- PARA SISTEMAS WINDOWS/MAC (Docker Desktop) ---
      - SPRING_DEVTOOLS_RESTART_TRIGGER_FILE=.trigger
      - CHOKIDAR_USEPOLLING=true

      # --- LOGGING ---
      - SPRING_OUTPUT_ANSI_ENABLED=ALWAYS
      - DEBUG=true

      # --- ACTIVA PERFIL DOCKER (opcional) ---
      - SPRING_PROFILES_ACTIVE=docker
    user: "root"  # Evita problemas de permisos en Linux
    tty: true
    stdin_open: true
    depends_on:
      db:
        condition: service_healthy

  db:
    image: mysql:8.0
    container_name: spring_petcare_db
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: clinica_db
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      timeout: 20s
      retries: 10
      start_period: 40s

volumes:
  mysql-data:
  maven-repo:
